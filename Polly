using System;                     // Temel .NET sınıflarını (Console, Exception vb.) kullanmak için.
using System.Net.Http;            // HTTP istekleri göndermek için gerekli.
using Polly;                      // Polly kütüphanesini kullanmak için (dayanıklılık politikaları sağlar).

namespace PollyTutorial
{
    class Program
    {
        // Main metodu — asenkron olarak çalışıyor çünkü HTTP istekleri async/await kullanıyor.
        static async Task Main()
        {
            // Örnek olması için bir HttpClient nesnesi oluşturuluyor.
            // Gerçek projelerde, HttpClient genellikle tek bir instance olarak paylaşılır.
            var httpClient = new HttpClient();

            // Temel bir "retry" politikası tanımlanıyor:
            // -> Sadece HttpRequestException hatası durumunda çalışır.
            // -> 3 kez yeniden deneme yapar.
            // -> Her deneme arasında 2 saniye bekler.
            var retryPolicy = Policy
                                .Handle<HttpRequestException>()            // Yalnızca HTTP isteği hatalarını ele alır.
                                .WaitAndRetryAsync(                         // Asenkron olarak bekleyip yeniden dener.
                                    3,                                      // Toplam 3 deneme yapılacak.
                                    retryAttempt => TimeSpan.FromSeconds(2) // Her deneme arasında 2 saniye bekleme.
                                );

            try
            {
                // Yukarıda tanımlanan politika ile bir HTTP isteği yapılır.
                // Eğer istek başarısız olursa (örneğin bağlantı hatası), Polly otomatik olarak yeniden dener.
                await retryPolicy.ExecuteAsync(async () =>
                {
                    // Gerçek API çağrısı burada yapılır.
                    // "https://api.example.com" adresine GET isteği gönderiliyor.
                    var response = await httpClient.GetAsync("https://api.example.com");

                    // Eğer sunucu 200 (OK) dışında bir yanıt dönerse, bu satır hata fırlatır.
                    response.EnsureSuccessStatusCode();

                    // Burada yanıtın içeriği işlenebilir (örneğin JSON deserialize edilebilir).
                    // string result = await response.Content.ReadAsStringAsync();
                });
            }
            catch (HttpRequestException ex)
            {
                // HTTP isteği başarısız olduğunda yakalanır.
                Console.WriteLine($"Bir HTTP hatası oluştu: {ex.Message}");
            }
            catch (Exception ex)
            {
                // Diğer beklenmeyen hatalar burada yakalanır.
                Console.WriteLine($"Bir hata oluştu: {ex.Message}");
            }
        }
    }
}
